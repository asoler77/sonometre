/****************************************
Example Sound Level Sketch for the 
Adafruit Microphone Amplifier
****************************************/
 
#define Nconst 200 // maxim 800
const int sampleWindow = 100; // Sample window width in mS (50 mS = 20Hz)
unsigned int sample;
int buffer[Nconst];
 
void setup() 
{
	Serial.begin(9600);
	pinMode(2, OUTPUT);
	pinMode(3, OUTPUT);
	pinMode(4, OUTPUT);
	digitalWrite(2, LOW);
	digitalWrite(3, HIGH);
	digitalWrite(4, HIGH);
}

void loop() 
{
	unsigned long startMillis= millis();  // Start of sample window
	unsigned int peakToPeak = 0;   // peak-to-peak level

	unsigned int signalMax = 0;
	unsigned int signalMin = 1024;

	//static int N = 150;	// Número de mostres de la mitjana. Maxim 800
	static int i=0;
	static int N=Nconst;
	static double mean = 0;	// mitjana promitjada en N mostres de sampleWindow ms.
	static int state = 0;	// 2 vermell, 1 taronja, 0 verd
	static unsigned long counter = 0;

	// a 50ms fa unes pren unes 445 mostres, 8,9KHz de mostreig.
	while (millis() - startMillis < sampleWindow)
	{
		sample = analogRead(0);
		if (sample < 1024)  // toss out spurious readings
		{
			if (sample > signalMax)
			{
				signalMax = sample;  // save just the max levels
			}
			else if (sample < signalMin)
			{
				signalMin = sample;  // save just the min levels
			}
		}
	}


	peakToPeak = signalMax - signalMin;  // max - min = peak-peak amplitude
	int volts = peakToPeak;  // convert to volts


	buffer[i] = volts;
	i=i+1;
	if(i==N){i=0;}
	
	//for(int j=0;j<N-1;j++){if(buffer[j]>max0){max0=buffer[j];}}
	mean = 0;
	for(int j=0;j<N-1;j++){mean = mean + buffer[j];}
	mean = mean/N;
	
	if(mean>230){	// Nivell de la mitjana per passar a vermell
		digitalWrite(2, HIGH);
		digitalWrite(3, HIGH);
		digitalWrite(4, LOW);
		state = 2;
		counter = millis(); // iniciem el contador per reduir l'estat
	}
	else{
		if(mean>170 && state!=2){ // Nivell de la mitjana per passar a taronja
			digitalWrite(2, HIGH);
			digitalWrite(3, LOW);
			digitalWrite(4, HIGH);
			state = 1;
			counter = millis(); // iniciem el contador per reduir l'estat
		}
	}

	if(state!=0){	// Si hem canviat a taronja o vermell

		if(millis() - counter > 5000){ // Temps en segons per baixar el semàfor.
			if(state==1){ // si estavem a taronja i ha passat el temps paseem a verd.
				state=0;
				digitalWrite(2, LOW);
				digitalWrite(3, HIGH);
				digitalWrite(4, HIGH);				
			}
			if(state==2){ // si estavem en vermell i ha passat el temps passem a taronja i reinciem el counter.
				state=1;
				digitalWrite(2, HIGH);
				digitalWrite(3, LOW);
				digitalWrite(4, HIGH);
				counter = millis(); 
			}
		}	
	}

	Serial.println(mean);

}
